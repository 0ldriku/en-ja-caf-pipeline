"""
JA pipeline validation: steps 3-7
Run from: release_en_ja_shared_20260224/

Usage:
    python validate_pipeline_ja.py
"""

import subprocess
import sys
from pathlib import Path

# ── configure ──────────────────────────────────────────────────────────────────
RELEASE    = Path(__file__).parent.resolve()
PYTHON_ASR = r"C:\Users\riku\miniconda3\envs\qwen3-asr\python.exe"   # filler scoring
PYTHON_JA  = str(RELEASE.parent / r"ja\.venv_electra310\Scripts\python.exe")  # clause/CAF
JA         = "ja/rq3_v16_clean_release_20260223"
OUT        = "validation_run/ja"
# ───────────────────────────────────────────────────────────────────────────────


def run(cmd):
    print("\n>>>", " ".join(str(x) for x in cmd))
    r = subprocess.run([str(x) for x in cmd], cwd=str(RELEASE))
    if r.returncode != 0:
        print(f"FAILED (exit {r.returncode})")
        sys.exit(r.returncode)


# Step 3 — Clause segmentation (auto side only)
run([PYTHON_JA, f"{JA}/scripts/ja_clause_segmenter_v16.py",
     "-i", f"{JA}/results/qwen3_filler_mfa_ja_v2_spanfix_b_l1_focus20/textgrids_clean",
     "-o", f"{OUT}/auto_clauses",
     "--model", "ja_ginza_electra"])

# Step 4 — Manual gold reference (pre-existing, not re-segmented)
# Gold clauses: ja/rq3_v16_clean_release_20260223/manual_clauses_gold_v2/

# Step 5 — Gap-only neural filler candidate scoring
run([PYTHON_ASR, "shared/postprocess_vad_filler_classifier_en.py",
     "--file-list-json", f"{JA}/analysis/rq3_gaponly_neural_t050_freshrun_20260224/file_list_40.json",
     "--file-list-key", "all_selected",
     "--audio-dir", "ja/data/manual20_0220_2",
     "--asr-json-dir", f"{JA}/results/qwen3_filler_mfa_ja_v2_spanfix_b_l1_focus20/json",
     "--model-path", "shared/filler_classifier/model_podcastfillers_neural_v1_full/model.pt",
     "--threshold", "0.50",
     "--gap-only",
     "--out-dir", f"{OUT}/candidates"])

# Step 6 — Auto CAF with candidate fillers applied
run([PYTHON_JA, f"{JA}/scripts/caf_calculator_ja_gap_classifier.py",
     f"{OUT}/auto_clauses",
     "--candidate-dir", f"{OUT}/candidates/per_file",
     "--file-list-json", f"{JA}/analysis/rq3_gaponly_neural_t050_freshrun_20260224/file_list_40.json",
     "--file-list-key", "all_selected",
     "--output", f"{OUT}/auto_caf.csv"])

# Step 7a — Manual CAF (uses gold clause TextGrids — not re-segmented)
run([PYTHON_JA, f"{JA}/scripts/caf_calculator_ja.py",
     f"{JA}/results/manual_clauses_gold_v2",
     "--output", f"{OUT}/manual_caf.csv"])

# Step 7b — Correlation / probe summary
# --baseline-auto-csv and --vad-auto-csv: use the pre-existing baseline auto CAF
run([PYTHON_JA, f"{JA}/scripts/run_rq3_vad_classifier_probe_ja.py",
     "--baseline-auto-csv", f"{JA}/auto_caf_results.csv",
     "--vad-auto-csv",      f"{JA}/auto_caf_results.csv",
     "--clf-auto-csv",      f"{OUT}/auto_caf.csv",
     "--manual-csv",        f"{OUT}/manual_caf.csv",
     "--out-summary",       f"{OUT}/probe/probe_summary.csv",
     "--out-mcpd-deltas",   f"{OUT}/probe/probe_mcpd_file_deltas.csv"])

print(f"\nDone. Outputs in: {RELEASE / OUT}")
